<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Input - muwave</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìù User Input</h1>
            <p>Send messages through the muwave audio protocol</p>
        </header>
        
        <nav class="nav">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/user" class="nav-link active">User Input</a>
            {% for party in parties %}
            <a href="/party/{{ party.party_id }}" class="nav-link" style="border-color: {{ party.color }}">
                {{ party.name }}
            </a>
            {% endfor %}
        </nav>
        
        <main class="main">
            <div class="grid">
                <!-- Message Input -->
                <div class="card wide">
                    <h2>Compose Message</h2>
                    <div class="message-composer">
                        <div class="form-group">
                            <label for="target-party">Target Party</label>
                            <select id="target-party" class="form-control">
                                <option value="">-- Select Party --</option>
                                {% for party in parties %}
                                <option value="{{ party.party_id }}">{{ party.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="message-text">Message</label>
                            <textarea id="message-text" class="form-control" 
                                      placeholder="Enter your message here..." 
                                      rows="5"></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary btn-large" onclick="sendMessage()">
                                üì° Transmit via Audio
                            </button>
                            <button class="btn btn-secondary btn-large" onclick="sendToAI()">
                                ü§ñ Send to AI & Transmit
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Audio Preview -->
                <div class="card wide">
                    <h2>Audio Preview</h2>
                    <canvas id="waveform-canvas" width="800" height="150"></canvas>
                    <div class="transmission-status">
                        <div class="status-indicator" id="status-indicator">
                            <span class="status-dot idle"></span>
                            <span class="status-text">Idle</span>
                        </div>
                        <div class="progress-container" id="transmission-progress" style="display: none;">
                            <div class="progress-bar large">
                                <div class="progress-fill" id="tx-progress-bar"></div>
                            </div>
                            <span class="progress-text" id="tx-progress-text">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Transmission Queue -->
                <div class="card">
                    <h2>Transmission Queue</h2>
                    <div class="queue-container" id="queue-container">
                        <div class="queue-empty">
                            <p>No pending transmissions</p>
                        </div>
                    </div>
                </div>
                
                <!-- Response Display -->
                <div class="card">
                    <h2>AI Response</h2>
                    <div class="response-container" id="response-container">
                        <p class="placeholder">AI responses will appear here...</p>
                    </div>
                </div>
                
                <!-- Conversation Log -->
                <div class="card wide">
                    <h2>Conversation Log</h2>
                    <div class="conversation-log large" id="conversation-log">
                        <!-- Messages will be populated here -->
                    </div>
                </div>
                
                <!-- System Stats -->
                <div class="card">
                    <h2>System Resources</h2>
                    <div class="stats-grid vertical">
                        <div class="stat">
                            <span class="stat-label">CPU</span>
                            <div class="progress-bar">
                                <div class="progress-fill cpu-bar" id="cpu-bar"></div>
                            </div>
                            <span class="stat-value" id="cpu-value">0%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">RAM</span>
                            <div class="progress-bar">
                                <div class="progress-fill ram-bar" id="ram-bar"></div>
                            </div>
                            <span class="stat-value" id="ram-value">0%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">GPU</span>
                            <div class="progress-bar">
                                <div class="progress-fill gpu-bar" id="gpu-bar"></div>
                            </div>
                            <span class="stat-value" id="gpu-value">N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- Spectrogram -->
                <div class="card wide">
                    <h2>Spectrogram</h2>
                    <canvas id="spectrogram-canvas" width="800" height="150"></canvas>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <p>muwave v0.1.3 | User Interface</p>
        </footer>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let selectedParty = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            initWaveform('waveform-canvas');
            initSpectrogram('spectrogram-canvas');
            
            // Party selection
            document.getElementById('target-party').addEventListener('change', function(e) {
                selectedParty = e.target.value;
            });
            
            // Enter key to send
            document.getElementById('message-text').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    sendMessage();
                }
            });
        });
        
        function sendMessage() {
            const text = document.getElementById('message-text').value.trim();
            if (!text) {
                showError('Please enter a message');
                return;
            }
            if (!selectedParty) {
                showError('Please select a target party');
                return;
            }
            
            updateStatus('sending', 'Queuing message...');
            
            fetch('/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    party_id: selectedParty
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'queued') {
                    addToQueue(text, selectedParty);
                    addToLog('user', text);
                    document.getElementById('message-text').value = '';
                    updateStatus('queued', 'Message queued for transmission');
                }
            })
            .catch(error => {
                showError('Failed to queue message: ' + error);
                updateStatus('error', 'Failed to queue');
            });
        }
        
        function sendToAI() {
            const text = document.getElementById('message-text').value.trim();
            if (!text) {
                showError('Please enter a message');
                return;
            }
            if (!selectedParty) {
                showError('Please select a target party');
                return;
            }
            
            updateStatus('processing', 'Sending to AI...');
            addToLog('user', text);
            
            fetch('/api/ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: text,
                    party_id: selectedParty,
                    transmit: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.response) {
                    showResponse(data.response);
                    addToLog('assistant', data.response);
                    if (data.transmitted) {
                        addToQueue(data.response, selectedParty);
                        updateStatus('queued', 'AI response queued');
                    }
                }
                if (data.error) {
                    showError(data.error);
                    updateStatus('error', 'AI error');
                }
            })
            .catch(error => {
                showError('Failed to send to AI: ' + error);
                updateStatus('error', 'AI request failed');
            });
            
            document.getElementById('message-text').value = '';
        }
        
        function updateStatus(type, text) {
            const indicator = document.getElementById('status-indicator');
            const dot = indicator.querySelector('.status-dot');
            const statusText = indicator.querySelector('.status-text');
            
            dot.className = 'status-dot ' + type;
            statusText.textContent = text;
            
            if (type === 'sending') {
                document.getElementById('transmission-progress').style.display = 'flex';
            } else {
                document.getElementById('transmission-progress').style.display = 'none';
            }
        }
        
        function showResponse(text) {
            const container = document.getElementById('response-container');
            container.innerHTML = '<div class="response-text">' + escapeHtml(text) + '</div>';
        }
        
        function showError(text) {
            const container = document.getElementById('response-container');
            container.innerHTML = '<div class="error-text">' + escapeHtml(text) + '</div>';
        }
        
        function addToQueue(text, partyId) {
            const container = document.getElementById('queue-container');
            const empty = container.querySelector('.queue-empty');
            if (empty) empty.remove();
            
            const item = document.createElement('div');
            item.className = 'queue-item';
            item.innerHTML = `
                <span class="queue-text">${escapeHtml(text.substring(0, 50))}${text.length > 50 ? '...' : ''}</span>
                <span class="queue-status">Pending</span>
            `;
            container.appendChild(item);
        }
        
        function addToLog(role, text) {
            const log = document.getElementById('conversation-log');
            const msg = document.createElement('div');
            msg.className = 'message message-' + role;
            msg.innerHTML = `
                <span class="message-role">${role === 'user' ? 'You' : 'AI'}</span>
                <span class="message-content">${escapeHtml(text)}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            `;
            log.appendChild(msg);
            log.scrollTop = log.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Socket events
        socket.on('message_queued', function(data) {
            console.log('Message queued:', data);
        });
        
        socket.on('transmission_start', function(data) {
            updateStatus('sending', 'Transmitting...');
        });
        
        socket.on('transmission_complete', function(data) {
            updateStatus('idle', 'Transmission complete');
            // Remove from queue
            const items = document.querySelectorAll('.queue-item');
            if (items.length > 0) {
                items[0].remove();
            }
        });
    </script>
</body>
</html>
